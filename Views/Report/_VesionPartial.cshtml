@model WebTools.Models.ReportVersionViewModel
@{
    Layout = null;
}

<div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="addVersionLabel" aria-hidden="true" id="VersionPopup">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm phiên bản</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>         
            </div>
            <div class="modal-body">                
                <form method="post" asp-area="" asp-controller="Report" asp-action="AddVersion" id="myForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="IDBieuMau" name="IDBieuMau" value="@Model.VersionList.IDBieuMau"/>
                    <div class="row mb-3">
                        <div class="col-2"><label for="TenBM">Tên biểu mẫu:</label></div>
                        <div class="col"><span style="color:dodgerblue; font-weight:bold;">@Model.VersionList.TenBM</span></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-2"><label for="MaBM">Mã biểu mẫu:</label></div>
                        <div class="col"><span style="color:dodgerblue; font-weight:bold;">@Model.VersionList.MaBM</span></div>
                        <div class="col-3 text-right"><label for="NgayBanHanh">Ngày ban hành:</label></div>
                        <div class="col-3">
                            <div class="input-group date" id="reservationdate" data-target-input="nearest">
                                <input type="text" name="NgayBanHanh" id="NgayBanHanh" class="form-control datetimepicker-input" data-target="#reservationdate" data-inputmask-alias="datetime" data-inputmask-inputformat="dd/mm/yyyy" data-mask required value="@Model.VersionList.NgayBanHanhNew"/>
                                <div class="input-group-append" data-target="#reservationdate" data-toggle="datetimepicker">
                                    <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--Bảng -->
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Phiên bản</th>
                                <th>Ngày ban hành</th>
                                <th>Trạng thái</th>
                                <th>Ghi chú</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                if (Model.VersionLists != null && Model.VersionLists.Count > 0)
                                {
                                    foreach (var item in Model.VersionLists)
                                    { 
                                        <tr>
                                            <td>@item.STT</td>
                                            <td>@item.PhienBan</td>
                                            <td>@item.NgayBanHanh</td>
                                            <td>@item.TrangThai</td>
                                            <td>@item.GhiChu</td>
                                            @if (item.FileLink != null)
                                                {
                                                    <td><a href="/Report/DocumentView?link=@item.FileLink" target="_blank">File</a></td>
                                                }
                                            else {<td></td> }
                                        </tr>
                                    }
                                }
                            }
                        </tbody>
                    </table>
                    <div class="row mb-3">
                        <div class="col-2"><label for="fileUpload">File:</label></div>
                        <div class="col-5">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input fileUpload" id="fileUpload" name="fileUpload" />
                                <label class="custom-file-label" for="customFile">Choose file</label>
                            </div>
                        </div>
                        <div class="col text-right"><label for="PhienBanSD">Phiên bản:</label></div>
                        <div class="col"><input type="text" class="form-control" name="PhienBan" id="PhienBan" value="@Model.VersionList.PhienBan"/></div>
                        <div class="col mr-2 text-right"><label for="PhienBanSD">Số PB:&nbsp;<span style="color:dodgerblue; font-weight:bold;">@Model.VersionList.SoPB</span></label></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-2"><label for="GhiChu">Ghi chú:</label></div>
                        <div class="col"><input type="text" class="form-control" name="GhiChu" id="GhiChu" value="@Model.VersionList.GhiChu"/></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="submit" class="btn btn-primary" data-save="modalFile">Lưu</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        //Date picker
        $('#reservationdate').datetimepicker({
            format: 'DD/MM/YYYY'
        })

        //Datemask dd/mm/yyyy
        $('#datemask').inputmask('dd/mm/yyyy', { 'placeholder': 'dd/mm/yyyy' })
        $('[data-mask]').inputmask()
    })

    //File upload show name file
    $(function () {
        bsCustomFileInput.init()
    })

    $(function () {
        //Initialize Select2 Elements
        $('.select2').select2()
    })


    $(function () {
        $(this).on('click', '[data-save="modalFile"]', function (event) {           
            event.preventDefault();
            var actionUrl = $("#myForm").attr('action');
            var methodType = $("#myForm").attr('method');

            var formData = new FormData();
            formData.append("IDBieuMau", $("#IDBieuMau").val());
            formData.append("TenBM", $("#TenBM").val());
            formData.append("MaBM", $("#MaBM").val());
            formData.append("NgayBanHanh", $("#NgayBanHanh").val());
            formData.append("fileUpload", $("#fileUpload")[0].files[0]);
            formData.append("PhienBan", $("#PhienBan").val());
            formData.append("GhiChu", $("#GhiChu").val());
            $.ajax({
                type: methodType,
                url: actionUrl,
                data: formData,
                processData: false,
                contentType: false,

                success: function (data) {
                    alert("Thành công!");
                },
                error: function (data) {
                    alert("Lỗi!");
                }
            }).done(function (data) {
                $(this).find('.modal').modal('hide');
                location.reload();
            })
        });
    });
</script>